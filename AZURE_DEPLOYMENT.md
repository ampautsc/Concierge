# Azure Deployment Guide

This guide explains how to deploy the Habitat Restoration Concierge to Azure Static Web Apps with Azure AD authentication.

## Overview

The application is configured for deployment to Azure Static Web Apps with the following features:
- Automatic CI/CD via GitHub Actions
- Azure AD (Microsoft Entra ID) authentication alongside Firebase auth
- Static content hosting with global CDN
- Free SSL certificates
- Custom domain support

## Prerequisites

1. **Azure Account**
   - Active Azure subscription
   - Access to Azure Portal (https://portal.azure.com)

2. **GitHub Repository**
   - Repository connected to Azure Static Web Apps
   - GitHub secrets configured

3. **Azure AD App Registration** (for Microsoft sign-in)
   - Azure Active Directory tenant
   - App registration with appropriate permissions

## Step 1: Create Azure Static Web App

### Using Azure Portal

1. Sign in to [Azure Portal](https://portal.azure.com)

2. Click **Create a resource** > Search for **Static Web App**

3. Configure the Static Web App:
   - **Subscription**: Select your subscription
   - **Resource Group**: Create new or use existing
   - **Name**: Choose a unique name (e.g., `concierge-app`)
   - **Plan type**: Free (for development) or Standard (for production)
   - **Region**: Choose closest to your users
   - **Source**: GitHub
   - **Organization**: Your GitHub username/org
   - **Repository**: your-username/Concierge (or your fork)
   - **Branch**: main

4. Build Details:
   - **Build Presets**: React
   - **App location**: `/`
   - **Api location**: (leave empty)
   - **Output location**: `dist`

5. Click **Review + create** > **Create**

6. After deployment, Azure will:
   - Create a GitHub Actions workflow in your repository
   - Add `AZURE_STATIC_WEB_APPS_API_TOKEN` to your GitHub secrets
   - Deploy your application automatically

### Using Azure CLI

```bash
# Login to Azure
az login

# Create resource group
az group create \
  --name concierge-rg \
  --location eastus

# Create static web app
az staticwebapp create \
  --name concierge-app \
  --resource-group concierge-rg \
  --source https://github.com/your-username/Concierge \
  --branch main \
  --app-location "/" \
  --output-location "dist" \
  --login-with-github
```

## Step 2: Configure Azure AD Authentication

### Create App Registration

1. Go to **Azure Portal** > **Azure Active Directory** > **App registrations**

2. Click **New registration**:
   - **Name**: Habitat Restoration Concierge
   - **Supported account types**: 
     - Choose "Accounts in any organizational directory and personal Microsoft accounts"
   - **Redirect URI**: 
     - Platform: Single-page application (SPA)
     - URI: `https://your-app.azurestaticapps.net`
   - Click **Register**

3. Note the following values (you'll need them):
   - **Application (client) ID**
   - **Directory (tenant) ID**

4. Configure API permissions:
   - Click **API permissions** > **Add a permission**
   - Select **Microsoft Graph**
   - Choose **Delegated permissions**
   - Add these permissions:
     - `User.Read`
     - `openid`
     - `profile`
     - `email`
   - Click **Grant admin consent** (if you have admin rights)

5. Configure Authentication:
   - Click **Authentication**
   - Under **Implicit grant and hybrid flows**, check:
     - ✅ Access tokens
     - ✅ ID tokens
   - Under **Advanced settings**:
     - Allow public client flows: No
   - Click **Save**

### Add Redirect URIs

Add all your deployment URLs:
- Production: `https://your-app.azurestaticapps.net`
- Staging/Preview: `https://your-app-<stage>.azurestaticapps.net`
- Local development: `http://localhost:5173`

## Step 3: Configure GitHub Secrets

Add the following secrets to your GitHub repository:

1. Go to **GitHub Repository** > **Settings** > **Secrets and variables** > **Actions**

2. Add these secrets:

   **Azure Static Web Apps** (auto-created):
   - `AZURE_STATIC_WEB_APPS_API_TOKEN` - Generated by Azure

   **Firebase Configuration**:
   - `VITE_FIREBASE_API_KEY`
   - `VITE_FIREBASE_AUTH_DOMAIN`
   - `VITE_FIREBASE_PROJECT_ID`
   - `VITE_FIREBASE_STORAGE_BUCKET`
   - `VITE_FIREBASE_MESSAGING_SENDER_ID`
   - `VITE_FIREBASE_APP_ID`

   **Azure AD Configuration**:
   - `VITE_AZURE_CLIENT_ID` - Application (client) ID from App registration
   - `VITE_AZURE_TENANT_ID` - Directory (tenant) ID from App registration

## Step 4: Deploy

Deployment happens automatically via GitHub Actions when you push to the `main` branch.

### Manual Deployment

If you need to deploy manually:

```bash
# Build the app locally
npm run build

# Install Azure Static Web Apps CLI
npm install -g @azure/static-web-apps-cli

# Deploy
swa deploy ./dist \
  --env production \
  --deployment-token $AZURE_STATIC_WEB_APPS_API_TOKEN
```

## Step 5: Configure Custom Domain (Optional)

1. Go to **Azure Portal** > Your Static Web App > **Custom domains**

2. Click **Add** > **Custom domain on other DNS**

3. Enter your domain (e.g., `concierge.campmonarch.org`)

4. Azure will provide CNAME records to add to your DNS provider:
   ```
   CNAME concierge.campmonarch.org -> your-app.azurestaticapps.net
   ```

5. Wait for DNS propagation (can take up to 48 hours)

6. SSL certificate is automatically provisioned and renewed

## Monitoring and Logs

### View Deployment Status

- **GitHub Actions**: Check the Actions tab in your repository
- **Azure Portal**: Static Web App > Deployments

### View Application Logs

```bash
# Install Azure CLI
az extension add --name staticwebapp

# View logs
az staticwebapp logs show \
  --name concierge-app \
  --resource-group concierge-rg
```

### Application Insights (Optional)

Enable Application Insights for detailed monitoring:

1. **Azure Portal** > Your Static Web App > **Application Insights**
2. Click **Enable**
3. Create new Application Insights resource or use existing
4. View metrics, logs, and performance data

## Troubleshooting

### Build Fails

**Issue**: Build fails in GitHub Actions

**Solution**:
- Check GitHub Actions logs
- Verify environment variables are set correctly
- Ensure `package.json` and dependencies are up to date
- Test build locally: `npm run build`

### Authentication Not Working

**Issue**: Microsoft sign-in fails

**Solution**:
- Verify Azure AD App registration redirect URIs include your deployment URL
- Check that Client ID and Tenant ID are correct in GitHub secrets
- Ensure API permissions are granted in Azure AD
- Check browser console for specific error messages

### Firebase Authentication Fails

**Issue**: Google/Apple sign-in not working

**Solution**:
- Verify Firebase credentials in GitHub secrets
- Check Firebase Console > Authentication > Authorized domains
- Ensure your Azure deployment URL is added to Firebase authorized domains

### Environment Variables Not Loading

**Issue**: App can't access configuration

**Solution**:
- Verify all secrets are added to GitHub repository
- Re-run the GitHub Actions workflow
- Check that secret names match exactly (including `VITE_` prefix)

### 404 Errors on Routes

**Issue**: Direct navigation to routes returns 404

**Solution**:
- Verify `staticwebapp.config.json` is present in repository root
- Check that `navigationFallback` is configured correctly
- Redeploy the application

## Environment Configuration

The app uses these environment variables:

### Required for Firebase
```env
VITE_FIREBASE_API_KEY=your_firebase_api_key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=123456789012
VITE_FIREBASE_APP_ID=1:123456789012:web:abcdef123456
```

### Required for Azure AD
```env
VITE_AZURE_CLIENT_ID=12345678-1234-1234-1234-123456789012
VITE_AZURE_TENANT_ID=12345678-1234-1234-1234-123456789012
```

## Cost Optimization

### Free Tier Includes
- 100 GB bandwidth per month
- Unlimited SSL certificates
- Custom domains
- Global CDN
- Authentication

### When to Upgrade to Standard
- Need more than 100 GB bandwidth
- Multiple custom domains
- Azure Functions API integration
- Private endpoints

## Security Best Practices

1. **Never commit secrets** - Always use GitHub Secrets
2. **Rotate tokens regularly** - Update API tokens periodically
3. **Use least privilege** - Only grant necessary permissions in Azure AD
4. **Enable App Insights** - Monitor for suspicious activity
5. **Keep dependencies updated** - Regular `npm audit` and updates
6. **Configure CSP headers** - Add Content-Security-Policy headers in `staticwebapp.config.json`

## Additional Resources

- [Azure Static Web Apps Documentation](https://docs.microsoft.com/azure/static-web-apps/)
- [Azure AD Authentication](https://docs.microsoft.com/azure/active-directory/develop/)
- [GitHub Actions for Azure](https://docs.microsoft.com/azure/static-web-apps/github-actions-workflow)
- [Custom Domains](https://docs.microsoft.com/azure/static-web-apps/custom-domain)
- [Environment Variables](https://docs.microsoft.com/azure/static-web-apps/application-settings)

## Support

For deployment issues:
- Check GitHub Actions logs
- Review Azure Static Web Apps documentation
- Open an issue in the repository

For authentication issues:
- Verify Azure AD configuration
- Check Firebase settings
- Review browser console errors
